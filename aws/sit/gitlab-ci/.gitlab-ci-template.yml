image: maven:3.9.9-amazoncorretto-17

stages:
  - build
  - test
  - artifact_upload_s3
  - check_version
  - deploy_sit

include:
  - template: Security/Dependency-Scanning.gitlab-ci.yml

variables:
  S3_BUCKET_NAME: "auxdromos-artifacts-unique"
  AWS_DEFAULT_REGION: "us-east-1"

build:
  stage: build
  script:
    - echo "Build del modulo $MODULE_NAME..."
    - mvn clean package -Paws -DskipTests
  artifacts:
    paths:
      - target

test:
  stage: test
  script:
    - echo "Test del modulo $MODULE_NAME..."
    - mvn test

artifact_upload_s3:
  stage: artifact_upload_s3
  image:
    name: amazon/aws-cli:latest
    entrypoint: [""]
  dependencies:
    - build
  script:
    - set -x
    - VERSION=$(grep "<version>" pom.xml | head -1 | sed 's/[<>]/|/g' | cut -d'|' -f3)
    - echo "Versione rilevata - $VERSION - Modulo $MODULE_NAME - $MODULE_NAME-$VERSION.jar"
    - aws s3 cp target/$MODULE_NAME-$VERSION.jar s3://$S3_BUCKET_NAME/$MODULE_NAME/ --region $AWS_DEFAULT_REGION
    - |
      files_to_delete=$(aws s3 ls s3://$S3_BUCKET_NAME/$MODULE_NAME/ --region $AWS_DEFAULT_REGION | head -n -5 | awk '{print $4}')
      if [ -n "$files_to_delete" ]; then
        for file in $files_to_delete; do
          echo "Eliminazione del file: $file"
          aws s3 rm s3://$S3_BUCKET_NAME/$MODULE_NAME/$file --region $AWS_DEFAULT_REGION
        done
      else
        echo "Meno di 5 versioni presenti, nessun file eliminato"
      fi
    - exit 0
  only:
    - develop
  environment:
    name: sit

check_version:
  stage: check_version
  image: amazon/aws-cli:latest
  only:
    - main
  script:
    - 'set -x'
    - 'NEW_VERSION=$(grep "<version>" pom.xml | head -1 | sed "s/[<>]/|/g" | cut -d"|" -f3) && echo "Nuova versione rilevata: $NEW_VERSION"'
    - 'CURRENT_FILE=$(aws s3 ls s3://$S3_BUCKET_NAME/$MODULE_NAME/ --region $AWS_DEFAULT_REGION | awk '\''{print $4}'\'' | sort -V | tail -n1)'
    - 'if [ -n "$CURRENT_FILE" ]; then CURRENT_VERSION=$(echo "$CURRENT_FILE" | sed "s/$MODULE_NAME-//; s/\.jar//"); echo "Versione attualmente presente su S3: $CURRENT_VERSION"; else echo "Nessuna versione presente su S3."; fi'
    - 'if [ -n "$CURRENT_FILE" ]; then \
         if [ "$CURRENT_VERSION" = "$NEW_VERSION" ]; then \
           echo "Errore: la nuova versione ($NEW_VERSION) è la stessa di quella presente ($CURRENT_VERSION)"; exit 1; \
         fi; \
         SORTED=$(printf '"'"'%s\n'"'"' "$CURRENT_VERSION" "$NEW_VERSION" | sort -V | head -n1); \
         if [ "$SORTED" = "$NEW_VERSION" ]; then \
           echo "Errore: la nuova versione ($NEW_VERSION) non è successiva a quella presente ($CURRENT_VERSION)"; exit 1; \
         fi; \
       fi'
    - 'aws s3 ls s3://$S3_BUCKET_NAME/$MODULE_NAME/$MODULE_NAME-$NEW_VERSION.jar --region $AWS_DEFAULT_REGION'
    - 'if [ $? -eq 0 ]; then echo "Errore: la versione $NEW_VERSION è già presente su S3."; exit 1; else echo "La versione $NEW_VERSION non è presente su S3, procedo."; fi'


deploy_sit:
  stage: deploy_sit
  image: alpine:latest
  dependencies:
    - artifact_upload_s3
  before_script:
    - apk update && apk add --no-cache openssh-client bash docker-compose
    - mkdir -p ~/.ssh
    # Imposta la chiave privata per la connessione SSH
    - echo "$EC2_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
  script:
    # Copia lo script deploy.sh sull'istanza EC2
    - scp deploy.sh $EC2_USER@$EC2_HOST:/tmp/deploy.sh
    # Esegui lo script in remoto sull'istanza EC2
    - ssh $EC2_USER@$EC2_HOST 'bash /tmp/deploy.sh'
  only:
    - main
  environment:
    name: sit
